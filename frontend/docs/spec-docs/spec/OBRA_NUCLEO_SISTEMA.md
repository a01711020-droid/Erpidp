# LA OBRA COMO NÃšCLEO DEL SISTEMA ERP

## ğŸ¯ CONCEPTO FUNDAMENTAL

**LA OBRA ES EL CENTRO ABSOLUTO DEL SISTEMA**

En un ERP tradicional de retail/manufactura:
- **SUCURSAL** = Centro del negocio
- Todo parte de la sucursal (ventas, inventario, compras)

En nuestro ERP de Constructora:
- **OBRA** = Centro del negocio
- Todo parte de la obra (requisiciones, compras, pagos, destajos)

---

## ğŸ—ï¸ JERARQUÃA DEL SISTEMA

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                     â”‚
                    â”‚       OBRA          â”‚
                    â”‚  (Centro Absoluto)  â”‚
                    â”‚                     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚              â”‚              â”‚
                â–¼              â–¼              â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚REQUISICIONESâ”‚  â”‚ DESTAJOS â”‚  â”‚ INGRESOS â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚             â”‚
                â–¼             â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
         â”‚  COMPRAS   â”‚â—„â”€â”€â”€â”€â”€â”€â”˜
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   PAGOS    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ FLUJO DE DATOS (TODO PARTE DE LA OBRA)

### 1ï¸âƒ£ **Sin OBRA = Sin Sistema**
```
âŒ NO HAY OBRA
   â†“
âŒ NO HAY REQUISICIONES
âŒ NO HAY DESTAJOS
âŒ NO HAY COMPRAS
âŒ NO HAY PAGOS
âŒ NO HAY DASHBOARD
```

### 2ï¸âƒ£ **Con OBRA = Sistema Completo**
```
âœ… OBRA CREADA
   â”‚
   â”œâ”€> âœ… Se pueden crear REQUISICIONES
   â”œâ”€> âœ… Se pueden registrar DESTAJOS
   â”œâ”€> âœ… Se pueden emitir COMPRAS
   â””â”€> âœ… Se pueden programar PAGOS
       â””â”€> âœ… Dashboard tiene datos que mostrar
```

---

## ğŸ“Š FLUJO OPERATIVO COMPLETO

### Escenario Real: ConstrucciÃ³n de CASTELLO TORRE F/G/H (Obra 228)

```
PASO 1: OBRA ACTIVA
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OBRA: CASTELLO F/G/H (228)                         â”‚
â”‚ Estado: ACTIVA                                      â”‚
â”‚ Cliente: CASTELLO INMOBILIARIO                      â”‚
â”‚ Residente: Ing. Carlos MÃ©ndez                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
PASO 2a: REQUISICIÃ“N DE MATERIAL
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ REQUISICIÃ“N: REQ-228-001                           â”‚
â”‚ Obra: 228 â† OBLIGATORIO                            â”‚
â”‚ Solicitante: Ing. Carlos MÃ©ndez                     â”‚
â”‚ Material: Cemento, Acero, Block                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
PASO 2b: DESTAJO PROGRAMADO
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DESTAJO: Semana 6-2025                             â”‚
â”‚ Obra: 228 â† OBLIGATORIO                            â”‚
â”‚ Destajista: Abraham Garcia (AG)                    â”‚
â”‚ Concepto: Losa armada N1                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
PASO 3: COMPRA DE MATERIAL
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ORDEN COMPRA: 228-A01GM-CEMEX                      â”‚
â”‚ Obra: 228 â† OBLIGATORIO                            â”‚
â”‚ Origen: REQ-228-001                                 â”‚
â”‚ Proveedor: CEMEX                                    â”‚
â”‚ Material: Cemento 150 bultos                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
PASO 4: RECEPCIÃ“N DE FACTURA
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FACTURA: FAC-CEMEX-12345                           â”‚
â”‚ Obra: 228 â† OBLIGATORIO                            â”‚
â”‚ OC: 228-A01GM-CEMEX                                 â”‚
â”‚ Monto: $45,000.00                                   â”‚
â”‚ Vencimiento: 30 dÃ­as                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
PASO 5: PAGO A PROVEEDOR
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PAGO: PAG-228-001                                   â”‚
â”‚ Obra: 228 â† OBLIGATORIO                            â”‚
â”‚ Proveedor: CEMEX                                    â”‚
â”‚ Monto: $45,000.00                                   â”‚
â”‚ MÃ©todo: Transferencia                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
PASO 6: DASHBOARD CONSOLIDA
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DASHBOARD OBRA 228                                  â”‚
â”‚ - Requisiciones: 1 ($45,000)                        â”‚
â”‚ - Compras: 1 OC ($45,000)                          â”‚
â”‚ - Pagos: 1 ($45,000)                               â”‚
â”‚ - Destajos: 1 cuadrilla                            â”‚
â”‚ - Avance: 15% completado                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—‚ï¸ OBRA COMO FOREIGN KEY OBLIGATORIA

### Todas las entidades requieren `obra_id`:

```typescript
// âŒ INCORRECTO - No se puede crear sin obra
const requisicion = {
  folio: "REQ-001",
  // obra_id: ??? â† FALTA
  solicitante: "Juan PÃ©rez",
  items: [...]
}
// ERROR: No se puede guardar

// âœ… CORRECTO - Siempre con obra
const requisicion = {
  folio: "REQ-228-001",
  obra_id: "uuid-obra-228", // â† OBLIGATORIO
  solicitante: "Juan PÃ©rez",
  items: [...]
}
// OK: Se puede guardar
```

### Esquema de FK en todas las tablas:

```sql
-- REQUISICIONES
requisiciones.obra_id â†’ obras.obra_id (NOT NULL)

-- Ã“RDENES DE COMPRA
ordenes_compra.obra_id â†’ obras.obra_id (NOT NULL)

-- FACTURAS
facturas.obra_id â†’ obras.obra_id (NOT NULL)

-- PAGOS
pagos.obra_id â†’ obras.obra_id (NOT NULL)

-- DESTAJOS
avances_destajos.obra_id â†’ obras.obra_id (NOT NULL)
```

---

## ğŸ¯ OBRA = SUCURSAL = CENTRO DE COSTO

### ComparaciÃ³n con ERP Tradicional:

| ERP Retail/Manufactura | ERP Constructora IDP |
|------------------------|----------------------|
| Sucursal Matriz | OBRA: CASTELLO F/G/H |
| Sucursal Norte | OBRA: DOZA TORRE A |
| Sucursal Sur | OBRA: BALVANERA |
| | |
| **Cada sucursal tiene:** | **Cada obra tiene:** |
| - Inventario | - Requisiciones |
| - Ventas | - Compras |
| - Compras | - Pagos |
| - Gastos | - Destajos |
| - Personal | - Residentes |
| | |
| **Dashboard por sucursal** | **Dashboard por obra** |
| **Consolidado corporativo** | **Dashboard global** |

---

## ğŸ” PERMISOS BASADOS EN OBRA

### Usuarios asignados a obras especÃ­ficas:

```typescript
// Usuario Residente - Solo ve sus obras
const residenteCastello = {
  usuario_id: "uuid-1",
  nombre: "Ing. Carlos MÃ©ndez",
  rol: "residente",
  obras_asignadas: ["uuid-obra-228", "uuid-obra-229"] // Solo CASTELLO
}

// Al consultar requisiciones:
const requisiciones = await getRequisiciones();
// AutomÃ¡ticamente filtrado:
// WHERE obra_id IN ("uuid-obra-228", "uuid-obra-229")

// âŒ NO PUEDE ver requisiciones de DOZA (obras 230, 231)
// âŒ NO PUEDE ver requisiciones de BALVANERA (obras 232, 233)
```

### Admin y Gerente ven todas las obras:

```typescript
const gerente = {
  usuario_id: "uuid-2",
  nombre: "Lic. MarÃ­a GonzÃ¡lez",
  rol: "gerente",
  obras_asignadas: null // null = TODAS las obras
}

// Dashboard Global muestra:
// - CASTELLO: $X millones
// - DOZA: $Y millones  
// - BALVANERA: $Z millones
// - TOTAL: $X+Y+Z millones
```

---

## ğŸ“¦ ESTADOS DE UNA OBRA

### Ciclo de Vida:

```
1. ACTIVA
   â””â”€> La obra estÃ¡ en construcciÃ³n
       âœ… Se pueden crear requisiciones
       âœ… Se pueden registrar destajos
       âœ… Se pueden emitir compras
       âœ… Se pueden programar pagos

2. SUSPENDIDA
   â””â”€> La obra estÃ¡ pausada temporalmente
       âš ï¸ No se pueden crear nuevos movimientos
       âœ… Se pueden consultar datos histÃ³ricos

3. TERMINADA
   â””â”€> La obra finalizÃ³ exitosamente
       âŒ No se pueden crear movimientos
       âœ… Se pueden consultar reportes finales
       âœ… Se puede cerrar contabilidad

4. CANCELADA
   â””â”€> La obra se cancelÃ³
       âŒ No se pueden crear movimientos
       âš ï¸ Requiere cierre administrativo
```

---

## ğŸš€ IMPLICACIONES EN EL CÃ“DIGO

### 1. Selector de Obra Obligatorio

**En todos los mÃ³dulos debe haber selector de obra:**

```tsx
// MÃ³dulo Requisiciones
<RequisicionesLayout>
  <Header>
    <ObraSelector 
      value={obraActual}
      onChange={setObraActual}
      obras={obrasAsignadas}
    />
  </Header>
  <RequisicionesList obra_id={obraActual.obra_id} />
</RequisicionesLayout>
```

### 2. ValidaciÃ³n en Formularios

```tsx
// Al crear cualquier entidad
<FormularioRequisicion>
  <input type="hidden" name="obra_id" value={obraActual.obra_id} required />
  {/* El usuario NO puede cambiar la obra aquÃ­ */}
  {/* Solo desde el selector global del header */}
</FormularioRequisicion>
```

### 3. Queries Filtradas por Obra

```typescript
// Siempre filtrar por obra_id
async function getRequisiciones(obra_id: string) {
  const key = `requisicion:index:obra:${obra_id}`;
  const requisicionIds = await kv.get(key);
  return requisicionIds.map(id => kv.get(`requisicion:${id}`));
}

// âŒ NUNCA hacer:
async function getAllRequisiciones() {
  // Esto traerÃ­a datos de TODAS las obras
  // Potencial violaciÃ³n de seguridad
}
```

### 4. Dashboard JerÃ¡rquico

```tsx
// Dashboard Global (Gerente)
<DashboardGlobal>
  {obras.map(obra => (
    <ObraCard key={obra.obra_id}>
      <h3>{obra.nombre_obra}</h3>
      <p>Compras: {getComprasTotal(obra.obra_id)}</p>
      <p>Pagos: {getPagosTotal(obra.obra_id)}</p>
      <p>Destajos: {getDestajosTotal(obra.obra_id)}</p>
      <Link to={`/dashboard/obras/${obra.codigo_obra}`}>
        Ver Detalle
      </Link>
    </ObraCard>
  ))}
</DashboardGlobal>

// Dashboard Individual (Residente)
<DashboardObra obra_id="uuid-228">
  <h1>CASTELLO F/G/H</h1>
  <RequisicionesResumen obra_id="uuid-228" />
  <ComprasResumen obra_id="uuid-228" />
  <PagosResumen obra_id="uuid-228" />
  <DestajosResumen obra_id="uuid-228" />
</DashboardObra>
```

---

## ğŸ“‹ REGLAS DE NEGOCIO

### âœ… REGLAS ABSOLUTAS:

1. **Toda entidad DEBE tener obra_id**
   - No se puede crear requisiciÃ³n sin obra
   - No se puede crear compra sin obra
   - No se puede crear pago sin obra
   - No se puede capturar destajo sin obra

2. **El cÃ³digo de folio DEBE incluir cÃ³digo de obra**
   - RequisiciÃ³n: REQ-**228**-001
   - Orden Compra: **228**-A01GM-CEMEX
   - Pago: PAG-**228**-001
   - Avance: AV-**228**-2025-W06

3. **Los usuarios solo ven obras asignadas**
   - Excepto admin y gerente (ven todas)
   - Filtrado automÃ¡tico en todas las queries
   - ValidaciÃ³n en servidor

4. **Dashboard consolida por obra**
   - Cada obra tiene sus mÃ©tricas
   - Dashboard global suma todas las obras
   - Filtros por estado de obra

5. **Reportes siempre incluyen obra**
   - Reporte de compras: agrupado por obra
   - Reporte de pagos: agrupado por obra
   - Reporte de destajos: agrupado por obra

---

## ğŸ¯ RESUMEN EJECUTIVO

### **LA OBRA ES:**

âœ… El centro del sistema  
âœ… La unidad de negocio  
âœ… El filtro principal de datos  
âœ… El centro de costo  
âœ… La fuente de ingresos  
âœ… El contexto de todas las operaciones  

### **SIN OBRA NO HAY:**

âŒ Requisiciones  
âŒ Compras  
âŒ Pagos  
âŒ Destajos  
âŒ Dashboard  
âŒ Sistema  

### **TODAS LAS ENTIDADES DEPENDEN DE OBRA:**

```
OBRA
 â”œâ”€â”€ Requisiciones â†’ Compras â†’ Pagos
 â”œâ”€â”€ Destajos â†’ Avances â†’ Pagos
 â””â”€â”€ Dashboard â†’ ConsolidaciÃ³n â†’ Reportes
```

---

**Documento creado:** 2025-02-09  
**VersiÃ³n:** 1.0  
**Estado:** âœ… Concepto fundamental documentado
